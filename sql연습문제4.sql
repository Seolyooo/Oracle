/*
2025/07/23
설유진
sql 연습문제 4

*/

--실습 2
drop table member;
create table member(
member_id number(4) primary key,
name varchar2(40) not null,
address varchar2(100),
hp char(13) unique,
join_date date not null
);
drop table book;
create table book(
book_id number(5) primary key,
title varchar2(50)  not null,
author varchar2(40)  not null,
publisher varchar2(40) not null,
available char(1),
reg_date  date not null
);
drop table loan;
CREATE TABLE loan (
    loan_id     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    member_id   NUMBER(4) NOT NULL,
    book_id     NUMBER(5) NOT NULL,
    loan_date   DATE,
    return_date DATE,
    actual_date DATE,
    FOREIGN KEY (member_id) REFERENCES member(member_id),
    FOREIGN KEY (book_id) REFERENCES book(book_id)
);


--실습 3
-- member
INSERT INTO member VALUES (1001, '김유신', '서울특별시강남구역삼동', '010-1234-1001', TO_DATE('2024-01-10 09:15:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO member VALUES (1002, '김춘추', '대전광역시유성구장대동', '010-1234-1002', TO_DATE('2024-02-14 14:30:45', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO member VALUES (1003, '장보고', '대구광역시수성구반월동', '010-1234-1003', TO_DATE('2024-03-01 11:05:20', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO member VALUES (1004, '강감찬', '부산광역시금정구부곡동', '010-1234-1004', TO_DATE('2024-03-22 16:40:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO member VALUES (1005, '이순신', '광주광역시광산구우산동', '010-1234-1005', TO_DATE('2024-04-10 08:50:10', 'YYYY-MM-DD HH24:MI:SS'));

-- book
INSERT INTO book VALUES (10001, '태백산맥', '조정래', '문학수첩', 'Y', TO_DATE('2014-01-10 09:15:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10002, '데미안', '헤르만 헤세', '민음사', 'N', TO_DATE('2014-02-14 14:30:45', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10003, '토지', '박경리', '문학사상사', 'Y', TO_DATE('2014-03-01 11:05:20', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10004, '명품자바프로그래밍', '제임스고슬링', '한빛출판사', 'Y', TO_DATE('2014-03-22 16:40:00', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10005, '로미오와줄리엣', '세익스피어', '열린책들', 'N', TO_DATE('2014-04-10 08:50:10', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10006, '삼국지', '나관중', '민음사', 'Y', TO_DATE('2014-04-05 09:12:02', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10007, '칼의노래', '김훈', '문학동네', 'Y', TO_DATE('2014-06-10 12:53:17', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10008, '데이터베이스', '래리엘리슨', '한빛출판사', 'N', TO_DATE('2014-05-23 10:13:09', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10009, 'Linux운영체제', '리누스토발즈', '한빛출판사', 'Y', TO_DATE('2014-03-11 11:23:43', 'YYYY-MM-DD HH24:MI:SS'));
INSERT INTO book VALUES (10010, '어린왕자', '생텍쥐베리', '열린책', 'Y', TO_DATE('2014-03-14 11:23:43', 'YYYY-MM-DD HH24:MI:SS'));

-- loan (loan_id는 자동 증가이므로 생략)
INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1001, 10002, TO_DATE('2024-03-01 10:02:31', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-03-15 10:02:31', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-03-13 09:44:19', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1002, 10004, TO_DATE('2024-03-05 15:10:02', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-03-19 15:10:02', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-03-12 17:12:30', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1003, 10008, TO_DATE('2024-04-01 11:01:12', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-04-15 11:01:12', 'YYYY-MM-DD HH24:MI:SS'), NULL);

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1002, 10001, TO_DATE('2024-04-10 14:32:01', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-04-24 14:32:01', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-04-22 13:56:32', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1005, 10004, TO_DATE('2024-04-15 16:24:21', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-04-29 16:24:21', 'YYYY-MM-DD HH24:MI:SS'), NULL);

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1004, 10006, TO_DATE('2024-05-01 09:12:09', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-05-15 09:12:09', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-05-14 09:21:27', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1001, 10007, TO_DATE('2024-05-03 13:51:07', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-05-17 13:51:07', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-05-16 14:05:10', 'YYYY-MM-DD HH24:MI:SS'));

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1003, 10009, TO_DATE('2024-06-01 11:15:43', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-06-15 11:15:43', 'YYYY-MM-DD HH24:MI:SS'), NULL);

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1004, 10004, TO_DATE('2024-06-02 12:30:52', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-06-16 12:30:52', 'YYYY-MM-DD HH24:MI:SS'), NULL);

INSERT INTO loan (member_id, book_id, loan_date, return_date, actual_date) 
VALUES (1002, 10008, TO_DATE('2024-06-05 10:06:17', 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('2024-06-19 10:06:17', 'YYYY-MM-DD HH24:MI:SS'), NULL);

--실습 4
select * from member;
--실습 5
select title,author from book;
--실습 6
select name, address from member where address like '부산%';
--실습 7
select title from book where available = 'Y';
--실습 8
select * from book where book_id=10005;
--실습 9
select member_id,name,hp from member where member_id =1002;

--실습 10
select * from book where publisher = '민음사';
--실습 11
select  loan_id,
 member_id,
 book_id from loan;

--실습 13
select * from member where name like '김%' ;

--실습 14
select * from member where address like '부산%' or address like '대구%';
--실습 15
select * from book where book_id in(10003,10006);

--실습 16
select name,join_date from member where join_date < '2024-04-01';
--실습 17
SELECT title, author FROM book 
WHERE author IN ('조정래', '박경리');

--실습 18
select loan_id,member_id,book_id,loan_date from loan 
where loan_date  >= '2024-05-01';

--실습 19
select title,author,publisher from book where available = 'N';
--실습 20
select * from book where title like '%자바%';
--실습 21
select name,hp from member where hp != '010-1234-1003';
--실습 22
select loan_id,member_id,book_id from loan 
where return_date <'2024-03-21';
--실습 23
select * from member order by name;
--실습 24
select title, reg_date from book order by reg_date desc;
--실습 25
select title from book order by title fetch first 3 rows only;

--실습 26
select * from member order by join_date desc 
fetch first 1 rows only;

--실습 27
select loan_id ,loan_date from loan order by loan_date desc
fetch first 2 rows only;
--실습 28
select count(*) from member;
--실습 29
select count(*) from book;
--실습 30
select count(*) from book where available ='Y';
--실습 31
select publisher, count(*) as 출판도서수 from book 
group by publisher;
--실습 32
select count(*) from loan;
--실습 33
select member_id,count(*) from loan group by member_id;
--실습 34
select book_id,count(*) from loan group by book_id;
--실습 35
select member_id ,count(*) as 회원대출건수 from loan 
group by member_id having count(*) >=2;
--실습 36
select * from ;
--실습 37
select l.member_id,m.name,l.book_id,b.title,l.loan_date 
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id;
--실습 38
select m.name,count(*) as 대출건수
from loan l
join member m on l.member_id=m.member_id
group by l.member_id,m.name having count(*) >= 3;
--실습 39
select loan_id,name,title,Loan_date
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
where loan_date <'2024-05-01';
--실습 40
select b.title
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id 
where m.name = '김유신';
--실습 41
select m.name
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
where title = '태백산맥';
--실습 42
select name,title
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
where name = '김춘추' order by title;
--실습 43
select *
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
where loan_date like '2024-04%';
--실습 44
select name,title
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
where actual_date is null;
--실습 45
select name,title
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
where author = '조정래';
--실습 46
select book_id,title
from book b 
where b.book_id not in (select book_id from loan);
--실습 47
select name,count(*) as 총건수
from loan l
join member m on l.member_id=m.member_id
join book b on l.book_id= b.book_id
group by m.name order by 총건수 desc;
--실습 48
SELECT m.name
FROM loan l
JOIN member m ON l.member_id = m.member_id
GROUP BY m.member_id, m.name
HAVING COUNT(*) = (
    SELECT MAX(loan_count)
    FROM (
        SELECT COUNT(*) AS loan_count
        FROM loan
        GROUP BY member_id
    )
);

--실습 49
SELECT distinct b.title
FROM loan l
join book b on l.book_id= b.book_id
where b.publisher in (
    SELECT publisher
    FROM book 
    where title ='데이터베이스'
    ) and b.title !='데이터베이스';

--실습 50
SELECT m.name
FROM loan l
join book b on l.book_id= b.book_id
join member m on l.member_id=m.member_id
where l.book_id in (
    SELECT book_id
    FROM loan 
    where book_id =10004
    );


select name from member where member_id in(
select member_id from loan where book_id = 10004);